<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- format for different screen sizes -->
    <title>AdventureAtlas</title> 
    <link rel="icon" type="image" href="{{ url_for('static', filename='images/logo_adventureatlas.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    
    <div id="react-root" class="root"></div>

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <script type="text/babel">
        const HUB_AUTHKEY = 'Crr-K24d-2N'; 
        const HUB_URL = "http://vm146.rz.uni-osnabrueck.de/hub";
        
        function ChannelApp(){
            const[content, setContent] = React.useState("");
            const [username, setUsername] = React.useState(localStorage.getItem("username") || ""); // store the username so it does not have to be entered with every message
            const [messages, setMessages] = React.useState([]); 
            const [newMessage, setNewMessage] = React.useState(""); // state to store the message input by the user
            const [channels, setChannels] = React.useState([]);
	    const [disableBotReply, setDisableBotReply] = React.useState(false);

	    const scrollToBottom = () => {
        	window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
	    };

	    const scrollToTop = () => {
        	window.scrollTo({ top: 0, behavior: "smooth" });
	    };

            React.useEffect(() => {
                // Fetch list of channels from HUB_URL
                fetch(HUB_URL + "/channels", {
                   headers: { Authorization: "authkey " + HUB_AUTHKEY },
                })
                    .then(response => response.json())
                    .then(data => setChannels(data.channels));
            }, []);

            const [currentChannel, setCurrentChannel] = React.useState("");
            
            const fetchMessages = async () => {
                try {
                    // fetch from the current channels endpoint
                    const response = await fetch (currentChannel.endpoint, {
                        method: 'GET',
                        headers: {
                            'Authorization': `authkey ${currentChannel.authkey}`
                        }
                    });
                    const data = await response.json();
                    console.log("Fetched messages:", data)

                    setMessages(data);
                } catch (error) {
                    console.error("Error fetching messages:", error);
                }
            };

            React.useEffect(() => {
                fetchMessages(); 
                const interval = setInterval(fetchMessages, 10000); //Polling every 10 sec
                return () => clearInterval(interval);
            }, [currentChannel]);

	    // scroll to bottom when the current channel changes
	    React.useEffect(() => {
        	scrollToBottom();
	    }, [currentChannel]);

	    // also scroll on initial page load
	    React.useEffect(() => {
        	scrollToBottom();
	    }, []);

            // handle form submission to send messages in the background
            const handleSubmit = async (e) => {
	        e.preventDefault();
        	if (!currentChannel || !currentChannel.endpoint) return;

	        // Build payload; include extra field only for AdventureAtlas channel
        	const payload = {
	            sender: username,
        	    content,
	            timestamp: new Date().toISOString()
        	};

	        if (currentChannel.name === "AdventureAtlas") {
        	    // if disableBotReply is true, set extra to "no_bot_reply", otherwise use "bot_reply"
	            payload.extra = disableBotReply ? "no_bot_reply" : "bot_reply";
        	}
        
	        try {
                //send the message to the channel endpoint
        	    await fetch(currentChannel.endpoint, {
                	method: 'POST', 
	                headers: {
        	            'Content-Type': 'application/json',
                	    'Authorization': `authkey ${currentChannel.authkey}`
	                },
        	        body: JSON.stringify(payload)    
	            });
        	    setContent(""); // clear input field after message was sent
                    fetchMessages(); // display the newest message immediately
		    scrollToBottom();
	        } catch(error) {
        	    console.error("Error sending messages", error);
	        }
	    };

            
            const handleUsernameChange = (name) => {
                setUsername(name);
                localStorage.setItem("username", name);
                };

            const handleLogout = () => {
                setUsername("");
                localStorage.removeItem("username");
            };

            return(
                <div>
                    <div className="header">
                        <h2>
                            <img 
                            src="{{ url_for('static', filename='images/logo_adventureatlas.png') }}"
                            alt="AdventureAtlas Logo" 
                            />
                            AdventureAtlas
                        </h2>
                        <div className="profile-tab">
                            {username ? (
                                <div>
                                    {/* greet the user if a username is stored */}
                                    <span>Hello {username}!</span>
                                    <img 
                                        src="{{ url_for('static', filename='images/profile-icon.png') }}" 
                                        alt="Profile Icon" 
                                        onClick={handleLogout}
                                    />
                                </div>
                            ) : (
                            <input 
                                type="text" 
                                placeholder="Enter your name" 
                                // handles the enter key event in the input field to save the username
                                onKeyDown={({ key, target }) => key === 'Enter' && handleUsernameChange(target.value)}
                            />
                            )}
                        </div>
                    </div>

                    <div className="sidebar">
                        <h2>Navigation</h2>
                        <ul>
                            {/* display the channel list */}
				<li>
                                    <a href={HUB_URL}>Public Hub</a>
                                </li>
                            {channels.map(channel => (
                                <li key={channel.endpoint}>
                                    <span 
                                        //save channel name and endpoint in currentChannel
                                        onClick={() => setCurrentChannel(channel)}>{channel.name}
                                    </span>				    
                                </li>
                            ))}
                        </ul>
			<br/>
			<br/>
			<br/> 
			<br/>
                   </div>

                    <div class="content">
                        <h1>{currentChannel.name}</h1>
                        {console.log(currentChannel)}
                        {/* display all messages of the channel */}
                        <div id="messages">
                            {messages.map((msg, index) => (
                                <div key={index} className="message">
                                <h2>{msg.sender}</h2>
                                <p className="content">{msg.content}</p>
                                <p className="timestamp">{msg.timestamp}</p>
                                </div>
                            ))}
                        </div>
                        {/* input field for typing messages */}
                        <form id="message-form" onSubmit={handleSubmit} className="message-form">
                            <label htmlFor="content">Message:</label>
                            <input
                                type="text"
                                name="content"
                                id="content"
                                value={content}
                                onChange={(e) => setContent(e.target.value)}
                                required
                            />

			    {/* checkbox to disable bot reply only if channel is AdventureAtlas */}
	                    {currentChannel.name === "AdventureAtlas" && (
                        	<label>
                	            <input 
        	                        type="checkbox" 
	                                checked={disableBotReply} 
                                	onChange={(e) => setDisableBotReply(e.target.checked)} 
                        	    />
                	            Disable the automatic bot reply
        	                </label>
	                    )}
                        
                        {/* Submit button to send the message */}
	                    <input type="submit" value="Post" disabled={!username}/>
                            {!username && (
                                <p>Please enter your name above to post a message.</p>
                            )}
                        </form>
                    </div>

                    <div className="footer">
			<button type="button" onClick={scrollToTop}>↑ Scroll to Top</button>	                             
	   	        <h2>
        	            <a href="{{ url_for('home_page') }}">Back to List of Channels</a>
                        </h2>
			<button type="button" onClick={scrollToBottom}>↓ Scroll to Bottom</button>
                    </div>
                </div>
            );
    
        }

    // Render the React component into the designated root div
    ReactDOM.render(<ChannelApp />, document.getElementById('react-root'));

    </script>

</body>
</html>
