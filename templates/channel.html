<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- format for different screen sizes -->
    <title>AdventureAtlas</title> <!-- title displayed in the browser tab -->
    <link rel="icon" type="image" href="{{ url_for('static', filename='images/logo_adventureatlas.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    
    <div id="react-root" class="root"></div>

    <script>
        var channelEndpoint = "{{ channel.endpoint|safe}}";
        var channelName = "{{ channel.name }}";
        var channelAuthkey = "";
        if (channelName === "Forum") {
            channelAuthkey = "0987654320";
        } else if (channelName === "Diary") {
            channelAuthkey = "0987654323";
        }
    </script>

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <script type="text/babel">
        // const HUB_AUTHKEY = 'Crr-K24d-2N'; //still adjust?!
        // const HUB_URL = "http://vm146.rz.uni-osnabrueck.de/hub";

        const HUB_AUTHKEY = '1234567890'
        const HUB_URL = 'http://localhost:5555'
        
        function ChannelApp(){
            const[sender, setSender] = React.useState("");
            const[content, setContent] = React.useState("");
            const [username, setUsername] = React.useState(localStorage.getItem("username") || "");
            // currentChannel can be "forum" or "diary" â€“ default is "forum"
            const [currentChannel, setCurrentChannel] = React.useState("forum");
            const [messages, setMessages] = React.useState([]);
            const [newMessage, setNewMessage] = React.useState("");

            const fetchMessages = async () => {
                try {
                    const response = await fetch (channelEndpoint, {
                        method: 'GET',
                        headers: {
                            'Authorization': `authkey ${channelAuthkey}`
                        }
                    });
                    const data = await response.json();
                    console.log("Fetched messages:", data)

                    //adjust maybe
                    setMessages([...data]);
                } catch (error) {
                    console.error("Error fetching messages:", error);
                }
            };

            React.useEffect(() => {
                fetchMessages(); // initial load
                const interval = setInterval(fetchMessages, 10000); //Polling every 10 sec
                return () => clearInterval(interval);
            }, []);

            // Handle form submission with fetch() to send messages in the background
            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    const response = await fetch(channelEndpoint,{
                        method: 'POST', 
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `authkey ${channelAuthkey}`
                        },
                        body: JSON.stringify({ sender, content, timestamp: new Date().toISOString() })    
                    });

                    const result = await response.json();
                    console.log(result);
                    // Clear inputs after successful send
                    setSender("");
                    setContent("");
                    
                } catch(error) {
                    console.error("Error sending messages", error);
                }
            };

            const handleUsernameChange = (e) => {
                const name = e.target.value;
                setUsername(name);
                localStorage.setItem("username", name);
                };

            const handleLogout = () => {
                setUsername("");
                localStorage.removeItem("username");
            };

            return(
                <div>
                    <div className="header">
                        <h2>
                            <img 
                            src="{{ url_for('static', filename='images/logo_adventureatlas.png') }}"
                            alt="AdventureAtlas Logo" 
                            />
                            AdventureAtlas
                        </h2>
                        <div className="profile-tab">
                            {username ? (
                                <div>
                                    <span>Hello, {username}</span>
                                    <img 
                                        src="{{ url_for('static', filename='images/profile-icon.png') }}" 
                                        alt="Profile Icon" 
                                        onClick={handleLogout}
                                    />
                                </div>
                            ) : (
                            <input 
                                type="text" 
                                placeholder="Enter your name" 
                                value={username} 
                                onChange={handleUsernameChange}
                                // onKeyDown={({ key, target }) => key === 'Enter' && handleUsernameChange(target.value)}
                            />
                            )}
                        </div>
                    </div>

                    <div className="sidebar">
                        <h2>Navigation</h2>
                        <a href="#" onClick={() => setCurrentChannel("forum")}>Forum</a>
                        <a href="#" onClick={() => setCurrentChannel("diary")}>Diary</a>
                    </div>

                    <div class="content">
                        <h1>
                            {currentChannel === "forum" ? "Travel Forum" : "My Travel Diary"}
                        </h1>
                        {currentChannel === "diary" && !username ? (
                            <p>Please enter your name in the header to view your diary entries.</p>
                        ) : (
                            <div id="messages">
                            {messages.map((msg, index) => (
                                <div key={index} className="message">
                                <h2>{msg.sender}</h2>
                                <p className="content">{msg.content}</p>
                                <p className="timestamp">{msg.timestamp}</p>
                                </div>
                            ))}
                            </div>
                        )}

                        <form id="message-form" onSubmit={handleSubmit} className="message-form">
                            <input type="hidden" name="channel" value={channelEndpoint} />
                            {username ? (
                            <input type="hidden" name="sender" value={username} />
                            ): (<div></div>)}
                            <label htmlFor="content">Message:</label>
                            <input
                                type="text"
                                name="content"
                                id="content"
                                value={content}
                                onChange={(e) => setContent(e.target.value)}
                                required
                            />
                            <input type="submit" value="Post" disabled={!username}/>
                            {!username && (
                            <p>Please enter your name above to post a message.</p>
                            )}
                        </form>
                    </div>

                    <div className="footer">
                    <h2>
                        <a href="{{ url_for('home_page') }}">Back to List of Channels</a>
                    </h2>
                    </div>
                </div>
            );
    
        }

    // Render the React component into the designated root div
    ReactDOM.render(<ChannelApp />, document.getElementById('react-root'));

    </script>

</body>
</html>